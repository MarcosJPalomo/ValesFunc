@{
    ViewData["Title"] = "MicrosipView";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="row">
    @if (User.IsInRole("Administrador") || User.IsInRole("Firma") || User.IsInRole("Almacen") || User.IsInRole("AlmacenMP"))
    {
        <div class="col-auto d-flex">
            <a style="color: #8a1bb6; border-color: transparent; cursor: pointer;" onclick="UpdateMicrosip()" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-original-title="Actualizar existencias" >
                <i class="bi bi-download" style="font-size: 32px"></i>
            </a>
        </div>
    }
    <div class="col">
        <h2 style="text-align: center;">Existencias</h2>
    </div>
    <div class="col-auto d-flex">
        <a style="color:  #85929e; border-color: transparent; cursor: pointer;" data-bs-toggle="collapse" href="#filter" role="button" aria-expanded="false" aria-controls="filter">
            <i id="filterIcon" class="bi bi-filter" style="font-size: 32px" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-original-title="Mostrar filtros"></i>
        </a>
    </div>
</div>
<hr />
<br />

<div class="row justify-content-between">
    <div class="col-9 flex-fill">
        <div id="Body">@Html.Raw(TempData["Message_Stock"])</div>
        <div id="partialViewContainer">
        </div>
    </div>
    <div class="collapse col-3" id="filter">
    <div style="background-color:  #eaecee; border: solid 2px #d5d8dc;">
        <ol class="list-group list-group-flush">
            <li class="list-group-item align-items-start">
                <h3 style="text-align: center;">Filtrar</h3>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-start">
                <div class="ms-2 me-auto">
                    <div class="fw-bold">Clave </div>
                    <input id="txtMSKey" type="text" class="form-control">
                </div>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-start">
                <div class="ms-2 me-auto">
                    <div class="fw-bold">Descripción </div>
                    <input id="txtDescr" type="text" class="form-control">
                </div>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-start">
                <div class="ms-2 me-auto">
                    <div class="fw-bold">Almacen </div>
                    <select id="cmbStorage" asp-items="@ViewBag.Storages" class="form-control">
                    </select>
                </div>
            </li>

            <li class="list-group-item d-flex justify-content-between align-items-start">
                <div class="ms-2 me-auto">
                    <div class="fw-bold">Grupos de líneas </div>
                    <select id="cmbGroupLine" asp-items="@ViewBag.GroupSupplyLines" class="form-control" onchange="FillCmbSupplyLine()">
                    </select>
                </div>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-start">
                <div class="ms-2 me-auto">
                    <div class="fw-bold">Líneas de artículos </div>
                    <select id="cmbSupplyLine" class="form-control">
                        <option value="0">-- Seleccionar línea --</option>
                    </select>
                </div>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-start">
                <div class="ms-2 me-auto">
                    <div class="fw-bold">Inspección </div>
                    <div class="form-check form-check-inline">
                        <input id="inspection1" class="form-check-input" type="checkbox" name="chbxInspection" value="1">
                        <label class="form-check-label">Sí</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input id="inspection0" class="form-check-input" type="checkbox" name="chbxInspection" value="0">
                        <label class="form-check-label">No</label>
                    </div>
                </div>
            </li>
                <li class="list-group-item d-flex justify-content-between align-items-start">
                    <div class="ms-2 me-auto">
                        <div class="fw-bold">Artículo </div>
                        <div class="form-check">
                            <input id="rdbtnRowM" name="rdbtnMaterial" class="form-check-input" type="radio" value="1">
                            <label class="form-check-label" for="flexCheckDefault">
                                Materia prima
                            </label>
                        </div>
                        <div class="form-check">
                            <input id="rdbtnWOM" name="rdbtnMaterial" class="form-check-input" type="radio" value="0">
                            <label class="form-check-label" for="flexCheckChecked">
                                Sin marcar
                            </label>
                        </div>
                        <div class="form-check">
                            <input id="rdbtnAllS" name="rdbtnMaterial" class="form-check-input" type="radio" value="2" checked>
                            <label class="form-check-label" for="flexCheckDefault">
                                Todos
                            </label>
                        </div>
                    </div>
                </li>
            <li class="list-group-item align-items-start">
                <div class="ms-2 me-auto">
                    <div class="fw-bold">Ordenar por</div>
                    <div class="form-check">
                        <input id="rdbtnDesc" name="rdbtnOrder" class="form-check-input" type="radio" value="3" checked>
                        <label class="form-check-label" for="flexCheckDefault">
                            Descripción
                        </label>
                    </div>
                    <div class="form-check">
                        <input id="rdbtnQty" name="rdbtnOrder" class="form-check-input" type="radio" value="1">
                        <label class="form-check-label" for="flexCheckChecked">
                            Cantidad total
                        </label>
                    </div>
                    <div class="form-check">
                        <input id="rdbtnMSKey" name="rdbtnOrder" class="form-check-input" type="radio" value="2">
                        <label class="form-check-label" for="flexCheckDefault">
                            Clave
                        </label>
                    </div>
                </div>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-start">
                <div class="ms-2 me-auto">
                    <div class="fw-bold">Opciones</div>
                    <div class="d-grid gap-2 d-md-block justify-content-between">
                        <a class="btn" onclick="ClearFilter()" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-original-title="Eliminar filtros"> <i class="bi bi-x-lg" style="font-size: 24px; color:#ca1f1f; border-color: transparent;"></i></a>
                        <a class="btn" onclick="GetData(1)" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-original-title="Buscar"> <i class="bi bi-search" style="font-size: 24px; color:#1f9bca; border-color: transparent;"></i></a>
                    </div>
                </div>
            </li>
        </ol>
        <br />
    </div>
    </div>
</div>

<script>
    window.onload = function () {
        FillCmbSupplyLine();
        GetData(1);
    };

    $("#txtMSKey").on('keyup', function (e) {
        if (e.key === 'Enter' || e.keyCode === 13) {
            GetData(1);
        }
    });

    $("#txtDescr").on('keyup', function (e) {
        if (e.key === 'Enter' || e.keyCode === 13) {
            GetData(1);
        }
    });

    function FillCmbSupplyLine() {
        var cmbGroupLine = document.getElementById("cmbGroupLine");
        var groupLine = cmbGroupLine.options[cmbGroupLine.selectedIndex].value;
        $.ajax({
            url: '/Stock/ListSupplyLine',
            data: { idGroupSupplyLine: groupLine},
            method: "GET",
            success: function (result) {
                $("#cmbSupplyLine").empty();
                var s = '<option value="0" selected>-- Seleccionar línea --</option>';
                for (var i = 0; i < result.length; i++) {
                    s += '<option value="' + result[i].idSupplyLine + '">' + result[i].name + '</option>';
                }
                $("#cmbSupplyLine").append(s);
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                alert("Status: " + textStatus); alert("Error: " + errorThrown);
                console.log(error);
            }
        });
    }

    function UpdateMicrosip(){
        $('#partialViewContainer').html('<div class="text-center"><div class="spinner-grow" style="width: 1rem; height: 1rem;" role="status"><span class="visually-hidden">Loading...</span></div>' +
            '<div class="spinner-grow" style="width: 1rem; height: 1rem;" role="status"><span class="visually-hidden">Loading...</span></div>' +
            '<div class="spinner-grow" style="width: 1rem; height: 1rem;" role="status"><span class="visually-hidden">Loading...</span></div><h4>Cargando datos...</h4></div>');
        $.ajax({
            url: '/Stock/UpdateData',
            method: "get",
            success: function (data) {
                window.location.href = data.redirectUrl;
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                console.log("Status: " + textStatus);
                console.log("Error: " + errorThrown);
            }
        });
    }

    function GetData(page) {
        $('#partialViewContainer').html('<div class="text-center"><div class="spinner-grow" style="width: 1rem; height: 1rem;" role="status"><span class="visually-hidden">Loading...</span></div>' +
            '<div class="spinner-grow" style="width: 1rem; height: 1rem;" role="status"><span class="visually-hidden">Loading...</span></div>' +
            '<div class="spinner-grow" style="width: 1rem; height: 1rem;" role="status"><span class="visually-hidden">Loading...</span></div><h4>Cargando datos...</h4></div>');
        var cmbStorage = document.getElementById("cmbStorage");
        var cmbGroupLine = document.getElementById("cmbGroupLine");
        var cmbSupplyLine = document.getElementById("cmbSupplyLine");
        var chbxInspection = document.getElementsByName('chbxInspection');
        var msKey = $("#txtMSKey").val();
        var descr = $("#txtDescr").val();
        var orderBy = $("input[name='rdbtnOrder']:checked").val();
        var rawMaterial = $("input[name='rdbtnMaterial']:checked").val();
        var storage = cmbStorage.options[cmbStorage.selectedIndex].value;
        var groupLine = cmbGroupLine.options[cmbGroupLine.selectedIndex].value;
        var supplyLine = cmbSupplyLine.options[cmbSupplyLine.selectedIndex].value;
        var inspection = "";
        for (var i = 0; i < chbxInspection.length; i++) {
            if (chbxInspection[i].checked) {
                inspection += "," + chbxInspection[i].value;
            }
        }
        if (inspection) { inspection = inspection.substring(1); }
        $.ajax({
            url: '/Stock/GetData',
            method: "post",
            data: { msKey: msKey, description: descr, orderBy: orderBy, inspection: inspection, storage: storage, groupLine: groupLine, supplyLine: supplyLine, rawMaterial: rawMaterial, page: page },
            success: function (data) {
                $("#partialViewContainer").html(data);
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                console.log("Status: " + textStatus);
                console.log("Error: " + errorThrown);
            }
        });
    };

    function ClearFilter() {
        var rdbtnQty = document.getElementById("rdbtnQty");
        var rdbtnDesc = document.getElementById("rdbtnDesc");
        var rdbtnMSKey = document.getElementById("rdbtnMSKey");
        rdbtnQty.checked = false;
        rdbtnDesc.checked = true;
        rdbtnMSKey.checked = false;
        var cmbStorage = document.getElementById("cmbStorage");
        var cmbGroupLine = document.getElementById("cmbGroupLine");
        var cmbSupplyLine = document.getElementById("cmbSupplyLine");
        cmbStorage.value = 0;
        cmbGroupLine.value = 0;
        cmbSupplyLine.value = 0;
        document.getElementById("inspection0").checked = false;
        document.getElementById("inspection1").checked = false;
        document.getElementById("txtMSKey").value = null;
        document.getElementById("txtDescr").value = null;
        var rdbtnRowM = document.getElementById("rdbtnRowM");
        var rdbtnWOM = document.getElementById("rdbtnWOM");
        var rdbtnAllS = document.getElementById("rdbtnAllS");
        rdbtnRowM.checked = false;
        rdbtnWOM.checked = false;
        rdbtnAllS.checked = true;
        FillCmbSupplyLine();
        GetData(1);
    }
</script>